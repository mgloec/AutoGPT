{% extends 'timetracker/base.html' %}

{% block title %}Tasks - {{ block.super }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div class="d-flex align-items-center">
                <h2 class="me-3">{% if is_manager %}Team Tasks{% else %}My Tasks{% endif %}</h2>
                <form method="get" class="d-flex align-items-center" id="filterForm">
                    <select name="team" class="form-select me-2" onchange="this.form.submit()">
                        <option value="">All Teams</option>
                        {% for team in available_teams %}
                        <option value="{{ team.id }}" {% if selected_team_id|stringformat:"s" == team.id|stringformat:"s" %}selected{% endif %}>
                            {{ team.name }}
                        </option>
                        {% endfor %}
                    </select>
                    <div class="input-group me-2">
                        <span class="input-group-text">From</span>
                        <input type="date" name="start_date" class="form-control" value="{{ start_date|default:'' }}" 
                               onchange="this.form.submit()">
                    </div>
                    <div class="input-group me-2">
                        <span class="input-group-text">To</span>
                        <input type="date" name="end_date" class="form-control" value="{{ end_date|default:'' }}"
                               onchange="this.form.submit()">
                    </div>
                </form>
            </div>
            <div>
                {% if is_manager %}
                <a href="{% url 'timetracker:export_tasks_excel' %}" class="btn btn-success me-2">
                    <i class="fas fa-file-excel"></i> Export to Excel
                </a>
                {% if managed_teams %}
                <a href="{% url 'timetracker:select_team_categories' %}" class="btn btn-info me-2">
                    <i class="fas fa-tags"></i> Manage Categories
                </a>
                {% endif %}
                {% endif %}
                <a href="{% url 'timetracker:select_team' %}" class="btn btn-primary">Add New Task</a>
            </div>
        </div>
        
        <div class="table-responsive">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Title</th>
                        <th>Category</th>
                        <th>Status</th>
                        <th>Start Time</th>
                        <th>End Time</th>
                        <th>Time Spent</th>
                        {% if is_manager %}
                        <th>Owner</th>
                        {% endif %}
                        <th>Team</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for task in tasks %}
                    <tr data-task-id="{{ task.pk }}">
                        <td>{{ task.title }}</td>
                        <td>{{ task.category.name }}</td>
                        <td>{{ task.get_status_display }}</td>
                        <td>{{ task.start_time|date:"Y-m-d H:i:s" }}</td>
                        <td>{{ task.end_time|date:"Y-m-d H:i:s" }}</td>
                        <td>
                            {% if task.start_time %}
                                <span class="duration" 
                                    data-start="{{ task.start_time|date:'c' }}" 
                                    data-end="{% if task.end_time %}{{ task.end_time|date:'c' }}{% endif %}">
                                    {{ task.duration }} minutes
                                </span>
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        {% if is_manager %}
                        <td>{{ task.owner.username }}</td>
                        {% endif %}
                        <td>{{ task.team.name }}</td>
                        <td>
                            {% if user == task.owner or user == task.team.manager %}
                            <div class="btn-group task-buttons">
                                <button type="button" class="btn btn-sm btn-success start-timer{% if task.status != 'not_started' or task.status == 'completed' %} d-none{% endif %}" data-task-id="{{ task.pk }}">
                                    <i class="fas fa-play"></i> Start
                                </button>
                                <button type="button" class="btn btn-sm btn-danger stop-timer{% if task.status != 'in_progress' %} d-none{% endif %}" data-task-id="{{ task.pk }}">
                                    <i class="fas fa-stop"></i> Stop
                                </button>
                                <a href="{% url 'timetracker:task_edit' task.pk %}" class="btn btn-sm btn-warning">Edit</a>
                                <a href="{% url 'timetracker:task_delete' task.pk %}" class="btn btn-sm btn-danger">Delete</a>
                            </div>
                            {% endif %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="{% if is_manager %}9{% else %}8{% endif %}" class="text-center">No tasks found.</td>
                    </tr>
                    {% endfor %}
                </tbody>
                <tfoot>
                    <tr class="table-secondary">
                        <td colspan="5" class="text-end fw-bold">Total Time Spent:</td>
                        <td class="total-duration" data-total-seconds="{{ total_duration_seconds }}">
                            Calculating...
                        </td>
                        <td colspan="{% if is_manager %}3{% else %}2{% endif %}"></td>
                    </tr>
                </tfoot>
            </table>
        </div>

        {% if page_obj.paginator.num_pages > 1 %}
        <nav aria-label="Task list pagination" class="mt-4">
            <ul class="pagination justify-content-center">
                {% if page_obj.has_previous %}
                    <li class="page-item">
                        <a class="page-link" href="?page=1{% if selected_team_id %}&team={{ selected_team_id }}{% endif %}{% if start_date %}&start_date={{ start_date }}{% endif %}{% if end_date %}&end_date={{ end_date }}{% endif %}" aria-label="First">
                            <span aria-hidden="true">&laquo;&laquo;</span>
                        </a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if selected_team_id %}&team={{ selected_team_id }}{% endif %}{% if start_date %}&start_date={{ start_date }}{% endif %}{% if end_date %}&end_date={{ end_date }}{% endif %}" aria-label="Previous">
                            <span aria-hidden="true">&laquo;</span>
                        </a>
                    </li>
                {% else %}
                    <li class="page-item disabled">
                        <span class="page-link">&laquo;&laquo;</span>
                    </li>
                    <li class="page-item disabled">
                        <span class="page-link">&laquo;</span>
                    </li>
                {% endif %}

                {% for num in page_obj.paginator.page_range %}
                    {% if page_obj.number == num %}
                        <li class="page-item active">
                            <span class="page-link">{{ num }}</span>
                        </li>
                    {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ num }}{% if selected_team_id %}&team={{ selected_team_id }}{% endif %}{% if start_date %}&start_date={{ start_date }}{% endif %}{% if end_date %}&end_date={{ end_date }}{% endif %}">{{ num }}</a>
                        </li>
                    {% endif %}
                {% endfor %}

                {% if page_obj.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if selected_team_id %}&team={{ selected_team_id }}{% endif %}{% if start_date %}&start_date={{ start_date }}{% endif %}{% if end_date %}&end_date={{ end_date }}{% endif %}" aria-label="Next">
                            <span aria-hidden="true">&raquo;</span>
                        </a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% if selected_team_id %}&team={{ selected_team_id }}{% endif %}{% if start_date %}&start_date={{ start_date }}{% endif %}{% if end_date %}&end_date={{ end_date }}{% endif %}" aria-label="Last">
                            <span aria-hidden="true">&raquo;&raquo;</span>
                        </a>
                    </li>
                {% else %}
                    <li class="page-item disabled">
                        <span class="page-link">&raquo;</span>
                    </li>
                    <li class="page-item disabled">
                        <span class="page-link">&raquo;&raquo;</span>
                    </li>
                {% endif %}
            </ul>
        </nav>
        <p class="text-center text-muted">
            Showing {{ page_obj.start_index }}-{{ page_obj.end_index }} of {{ page_obj.paginator.count }} tasks
        </p>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Keep track of running timers
    const runningTimers = new Map();
    
    function updateTaskRow(taskId, data) {
        const row = document.querySelector(`tr[data-task-id="${taskId}"]`);
        if (!row) return;

        // Update status
        const statusCell = row.querySelector('td:nth-child(3)');
        if (statusCell) {
            statusCell.textContent = data.status === 'in_progress' ? 'In Progress' : 'Completed';
        }

        // Update start time
        const startTimeCell = row.querySelector('td:nth-child(4)');
        if (startTimeCell && data.start_time) {
            startTimeCell.textContent = new Date(data.start_time).toLocaleString();
        }

        // Update end time
        const endTimeCell = row.querySelector('td:nth-child(5)');
        if (endTimeCell) {
            endTimeCell.textContent = data.end_time ? new Date(data.end_time).toLocaleString() : '';
        }

        // Update buttons
        const startButton = row.querySelector('.start-timer');
        const stopButton = row.querySelector('.stop-timer');
        
        if (data.status === 'in_progress') {
            startButton?.classList.add('d-none');
            stopButton?.classList.remove('d-none');
        } else if (data.status === 'completed') {
            // Hide both buttons for completed tasks
            startButton?.classList.add('d-none');
            stopButton?.classList.add('d-none');
        }
    }

    function startLiveDuration(taskId, startTime) {
        if (runningTimers.has(taskId)) {
            clearInterval(runningTimers.get(taskId));
        }

        const row = document.querySelector(`tr[data-task-id="${taskId}"]`);
        const durationCell = row.querySelector('td:nth-child(6)');
        const start = new Date(startTime);

        const timer = setInterval(() => {
            const now = new Date();
            const duration = Math.floor((now - start) / 60000); // Convert to minutes
            durationCell.textContent = duration;
        }, 1000);

        runningTimers.set(taskId, timer);
    }

    function stopLiveDuration(taskId) {
        if (runningTimers.has(taskId)) {
            clearInterval(runningTimers.get(taskId));
            runningTimers.delete(taskId);
        }
    }

    function setButtonLoading(button, loading) {
        if (loading) {
            button.disabled = true;
            button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Loading...';
        } else {
            button.disabled = false;
            button.innerHTML = button.classList.contains('start-timer') ? 
                '<i class="fas fa-play"></i> Start' : 
                '<i class="fas fa-stop"></i> Stop';
        }
    }

    function showError(message) {
        const alertDiv = document.createElement('div');
        alertDiv.className = 'alert alert-danger alert-dismissible fade show';
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;
        document.querySelector('.table-responsive').insertAdjacentElement('beforebegin', alertDiv);
        
        // Auto dismiss after 5 seconds
        setTimeout(() => {
            alertDiv.remove();
        }, 5000);
    }

    function startTimer(taskId, button) {
        setButtonLoading(button, true);
        
        fetch(`/timetracker/task/${taskId}/start/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            },
        })
        .then(response => response.json())
        .then(data => {
            setButtonLoading(button, false);
            if (data.error) {
                showError(data.error);
            } else {
                updateTaskRow(taskId, {
                    status: 'in_progress',
                    start_time: data.start_time,
                    duration: 0
                });
            }
        })
        .catch(error => {
            setButtonLoading(button, false);
            showError('An error occurred while starting the task');
            console.error('Error:', error);
        });
    }

    function stopTimer(taskId, button) {
        setButtonLoading(button, true);
        
        fetch(`/timetracker/task/${taskId}/stop/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            },
        })
        .then(response => response.json())
        .then(data => {
            setButtonLoading(button, false);
            if (data.error) {
                showError(data.error);
            } else {
                updateTaskRow(taskId, {
                    status: 'completed',
                    end_time: data.end_time,
                    duration: data.duration
                });
            }
        })
        .catch(error => {
            setButtonLoading(button, false);
            showError('An error occurred while stopping the task');
            console.error('Error:', error);
        });
    }

    // Initialize live timers for any in-progress tasks
    document.querySelectorAll('tr[data-task-id]').forEach(row => {
        const status = row.querySelector('td:nth-child(3)').textContent.trim();
        if (status === 'In Progress') {
            const taskId = row.dataset.taskId;
            const startTime = row.querySelector('td:nth-child(4)').textContent;
            if (startTime) {
                startLiveDuration(taskId, new Date(startTime));
            }
        }
    });

    document.querySelectorAll('.start-timer').forEach(button => {
        button.addEventListener('click', function() {
            startTimer(this.dataset.taskId, this);
        });
    });

    document.querySelectorAll('.stop-timer').forEach(button => {
        button.addEventListener('click', function() {
            stopTimer(this.dataset.taskId, this);
        });
    });

    // Convert duration from timestamps to a readable format
    document.querySelectorAll('.duration').forEach(function(element) {
        const startTime = new Date(element.dataset.start);
        const endTime = element.dataset.end ? new Date(element.dataset.end) : new Date();
        
        if (startTime) {
            const totalSeconds = Math.floor((endTime - startTime) / 1000);
            const hours = Math.floor(totalSeconds / 3600);
            const remainingSeconds = totalSeconds % 3600;
            const minutes = Math.floor(remainingSeconds / 60);
            const seconds = remainingSeconds % 60;

            const parts = [];
            
            // Always show all non-zero units and include seconds
            if (hours > 0) {
                parts.push(hours + 'h');
                parts.push(minutes + 'm');
                parts.push(seconds + 's');
            } else if (minutes > 0) {
                parts.push(minutes + 'm');
                parts.push(seconds + 's');
            } else {
                parts.push(seconds + 's');
            }

            element.textContent = parts.join(' ');
        }
    });

    // Format total duration
    const totalDurationElement = document.querySelector('.total-duration');
    if (totalDurationElement) {
        const totalSeconds = parseInt(totalDurationElement.dataset.totalSeconds);
        if (!isNaN(totalSeconds)) {
            const hours = Math.floor(totalSeconds / 3600);
            const remainingSeconds = totalSeconds % 3600;
            const minutes = Math.floor(remainingSeconds / 60);
            const seconds = remainingSeconds % 60;

            const parts = [];
            
            // Always show all non-zero units and include seconds
            if (hours > 0) {
                parts.push(hours + 'h');
                parts.push(minutes + 'm');
                parts.push(seconds + 's');
            } else if (minutes > 0) {
                parts.push(minutes + 'm');
                parts.push(seconds + 's');
            } else {
                parts.push(seconds + 's');
            }

            totalDurationElement.textContent = parts.join(' ');
        }
    }
});
</script>
{% endblock %}
